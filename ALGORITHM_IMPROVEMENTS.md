# 变量检测算法改进方案 V3

## 当前问题分析

### V1/V2 算法存在的问题

1. **形状变量过多**（占比 77%）
   - 装饰性形状被过度标记
   - 缺乏智能过滤机制
   - 导致噪音变量过多

2. **文本识别不够精准**
   - 13 个文本元素只识别出 6 个
   - 缺乏语义理解能力
   - 置信度计算过于简单

3. **缺乏上下文感知**
   - 不考虑元素位置、大小
   - 不考虑层级关系
   - 无法区分重要性

## V3 算法核心改进

### 1. 智能文本分析器 (SmartTextAnalyzer)

#### 多维度特征提取
```javascript
{
    length: 文本长度,
    hasNumber: 是否包含数字,
    hasChinese: 是否包含中文,
    hasEnglish: 是否包含英文,
    hasPunctuation: 是否包含标点,
    hasSpecialChar: 是否包含特殊字符,
    wordCount: 词数,
    sentenceCount: 句数
}
```

#### 重要性评分算法
- **长度得分** (20%)：15-100 字符最佳
- **结构得分** (30%)：标点、层次、混合语言
- **语义得分** (50%)：关键词匹配、特殊符号

#### 语义价值识别
- 高价值关键词：年会、大会、峰会、价值、转化、链接等
- 中价值关键词：时间、地点、服务、产品等
- 特殊符号加分：书名号《》、引号""、破折号——

### 2. 智能形状过滤器 (SmartShapeFilter)

#### 过滤策略
1. **尺寸过滤**：面积 < 100 的装饰性形状忽略
2. **颜色过滤**：纯白/纯黑背景需足够大（>50000）
3. **位置过滤**：边缘装饰性元素（待实现）
4. **复杂度过滤**：简单形状优先（待实现）

### 3. 增强版多标签检测器 (MultiTagDetectorV3)

#### 置信度阈值优化
每种类型设置最低置信度：
- 电话/邮箱：0.9（高精度）
- 日期/时间：0.85
- 人名/职位：0.75-0.8
- 通用文本：0.4（动态调整）

#### 动态置信度调整
通用文本的置信度 = 基础分(0.3) + 重要性(0-1) × 0.4
- 最低：0.3（低重要性文本）
- 最高：0.7（高重要性文本）

### 4. 变量类型定义优化

#### 新增字段
```javascript
{
    key: "类型键",
    category: "分类",
    label: "标签",
    priority: 优先级(1-5),
    minConfidence: 最低置信度阈值
}
```

#### 优先级设置
- Priority 1：核心变量（人名、日期、Logo等）
- Priority 2：重要变量（职位、时间、横幅等）
- Priority 3：描述变量
- Priority 5：通用变量（降低权重）

## 算法对比

| 维度 | V1/V2 | V3 |
|------|-------|-----|
| 文本分析 | 简单正则匹配 | 多维度特征 + 语义分析 |
| 形状过滤 | 无过滤 | 智能过滤（尺寸/颜色/位置） |
| 置信度 | 固定值 | 动态调整 + 阈值过滤 |
| 重要性 | 无 | 0-1 评分 |
| 上下文 | 无 | 位置/大小/层级（部分） |

## 预期效果

### 变量数量优化
- **V1/V2**：135 个变量（形状占 77%）
- **V3 预期**：20-30 个高质量变量

### 变量质量提升
- 形状变量减少 80%+
- 文本识别率提升至 90%+
- 高重要性文本全部识别

### 置信度分布
- 高置信度（>0.8）：30%+
- 中置信度（0.6-0.8）：50%
- 低置信度（<0.6）：20%

## 使用方式

### 集成到主程序
```javascript
// 在 AI_Template_Parser_v3.jsx 中
#include "lib/variable_detector_v3.jsx"

// 使用 V3 检测器
structure.variableAnalysisV3 = VariableDetectorV3.processElements(structure.elements);
structure.variableTemplateV3 = VariableDetectorV3.generateTemplate(structure.variableAnalysisV3.variables);
```

### 输出增强
V3 输出包含额外统计信息：
```javascript
{
    variables: [...],
    totalVariables: 数量,
    stats: {
        text: 文本元素数,
        image: 图片元素数,
        shape: 形状元素数,
        detected: 检测到的变量数,
        filtered: 过滤掉的数量,
        highImportance: 高重要性文本数
    }
}
```

## 后续优化方向

1. **上下文感知增强**
   - 利用元素层级关系
   - 考虑画板区域（header/body/footer）
   - 分析元素组合模式

2. **机器学习集成**
   - 基于历史数据训练分类器
   - 自动学习变量模式
   - 个性化置信度调整

3. **语义理解深化**
   - NLP 技术集成
   - 实体识别
   - 关系抽取

4. **性能优化**
   - 并行处理
   - 缓存机制
   - 增量更新

## 测试建议

1. 使用相同文件对比 V1/V2/V3 结果
2. 统计各版本的：
   - 变量总数
   - 类型分布
   - 置信度分布
   - 重要性分布
3. 人工评估变量质量
4. 调整阈值参数优化

## 配置参数

可调整的关键参数：
- `SmartShapeFilter.minArea`: 最小形状面积（默认 100）
- `SmartShapeFilter.minBgArea`: 最小背景面积（默认 50000）
- `SmartTextAnalyzer.weights`: 重要性权重分配
- `VAR_TYPES_V3.*.minConfidence`: 各类型最低置信度

---

**版本**: 3.0  
**创建时间**: 2026-01-03  
**状态**: 待测试集成
